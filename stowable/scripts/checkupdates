#!/usr/bin/env bash

readonly GH_API="https://api.github.com"

readonly bold=$(tput bold)
readonly reset=$'\e[0m'
readonly red=$'\e[31m'
readonly green=$'\e[32m'
readonly blue=$'\e[34m'
readonly magenta=$'\e[35m'
readonly white=$'\e[37m'

main() {
    simplecheck Repo n
    simplecheck AUR m
    gitcheck
}

simplecheck() {
    header "${1} Packages"
    pacaur -Qu "-${2}"
    echo
}

gitcheck() {
    local package version src branch hash

    header "AUR (Git) Packages"
    mkdir -p /tmp/aurcheck-git
    cd /tmp/aurcheck-git

    while read -r package version; do
        if grep -qv '\-git$' <<< "$package"; then
            # Skipping -git package
            continue
        fi

        fetch_metadata
        check_sources
        find_latest_commit
        pkg_status
    done <<< "$(pacaur -Qm)"
}

fetch_metadata() {
    curl -so "${package}.PKGBUILD" "https://aur.archlinux.org/cgit/aur.git/plain/.SRCINFO?h=${package}"
}

check_sources() {
    read -r src branch <<< "$(grep -m 1 'source = ' "${package}.PKGBUILD" | parse_ghurl)"

    if [ -z "$branch" ]; then
        branch=$(curl -s "${GH_API}/repos/${src}" | jq -r .default_branch)
    fi
}

find_latest_commit() {
    hash=$(curl -s "${GH_API}/repos/${src}/git/refs/heads/${branch}" | jq -r '.object.sha')
}

pkg_status() {
    echo -en "${blue}:: ${bold}${magenta}aur-git  ${white}${package} (${src}@${branch}) "
    echo -e "${red}${version}${reset} -> ${bold}${green}${hash:0:8}${reset}"
}

header() {
    echo "----------------------------------------"
    echo " $1"
    echo "----------------------------------------"
}

parse_ghurl() {
    sed -e 's/.*github.com\///g' -e 's/\(\.git$\|\(\.git\)\?\#branch=\)/ /g'
}

main

# vi: set ff=sh
