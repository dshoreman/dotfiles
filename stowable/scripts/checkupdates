#!/usr/bin/env bash

readonly GH_API="https://api.github.com"

readonly bold=$(tput bold)
readonly reset=$'\e[0m'
readonly red=$'\e[31m'
readonly green=$'\e[32m'
readonly yellow=$'\e[33m'
readonly magenta=$'\e[35m'
readonly cyan=$'\e[36m'
readonly white=$'\e[37m'

main() {
    simplecheck Repo n

    packages="$(simplecheck AUR m)"
    echo -e "$packages\n"

    mkdir -p ~/.cache/aurcheck-git
    header "AUR (Git) Packages"
    gitcheck | column -t -s'|'
}

simplecheck() {
    header "${1} Packages"
    pacaur -Qu "-${2}"
    echo
}

gitcheck() {
    local package version

    while read -r package version; do
        # Skipping already listed updates and non-git packages
        if [[ $packages == *"$package"* ]] || grep -qv '\-git$' <<< "$package"; then
            continue
        fi

        cd ~/.cache/aurcheck-git || return
        check_package
    done <<< "$(pacaur -Qm)"
}

check_package() {
    local src branch hash target srcdir="$HOME/.cache/aurcheck-git/${package}"

    fetch_metadata
    fetch_sources
    find_latest_commit
    update="$(pkgver)"
    pkg_status
}

fetch_metadata() {
    rm -rf "${package}"
    git clone -q "https://aur.archlinux.org/${package}.git" "${package}" && cd "${package}" || exit

    # shellcheck source=/usr/share/pacman/PKGBUILD-vcs.proto
    source PKGBUILD
}

fetch_sources() {
    src="${source[0]}"

    [[ ${src} == *"#branch="* ]] && branch=${src#*#branch=} && src=${src%#branch=*}
    [[ ${src} == *"::"* ]] && target="${src%::*}"
    src=${src#*github.com/}
    src=${src%.git}

    [ -z "$target" ] && target=$(basename "$src")
    [ -z "$branch" ] && query_default_branch

    git clone -q --bare --branch "${branch}" "https://github.com/${src}" "${target}"
}

query_default_branch() {
    if [ ! -f "${package}.branch" ]; then
        curl -s "${GH_API}/repos/${src}" | jq -r .default_branch > "${package}.branch"
    fi

    branch=$(<"${package}.branch")
}

find_latest_commit() {
    hash=$(curl -s "${GH_API}/repos/${src}/git/refs/heads/${branch}" | jq -r '.object.sha')
}

pkg_status() {
    echo -en "${bold}${cyan}:: ${magenta}aur-git|${white}${package} "
    echo -en "(${yellow}${src}${white}@${cyan}${branch}${white})|"
    echo -e "${red}${version}${reset}|->|${bold}${green}${update}|${hash:0:8}${reset}"
}

header() {
    echo "----------------------------------------"
    echo " $1"
    echo "----------------------------------------"
}

main

# vi: set ff=sh
